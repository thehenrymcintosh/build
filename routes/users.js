var express=require("express"),router=express.Router(),User=require("../models/user"),passport=require("passport"),LocalStrategy=require("passport-local").Strategy;router.get("/register",function(e,r){r.render("register")}),router.get("/login",function(e,r){r.render("login")}),router.post("/register",function(e,r){var s=e.body.name,o=e.body.username,i=e.body.email,n=e.body.password1,a=e.body.password2;e.checkBody("name","Name is required").notEmpty(),e.checkBody("username","Username is required").notEmpty(),e.checkBody("email","Email is required").notEmpty(),e.checkBody("email","Email is not valid").isEmail(),e.checkBody("password1","Password is required").notEmpty(),e.checkBody("password2","Password confirmation is required").notEmpty(),e.checkBody("password2","Passwords must match").equals(n);var t=e.validationErrors();t?r.render("register",{errors:t}):User.getUserByUsername(o,function(a,t){User.getUserByEmail(i,function(a,l){if(null!=t)console.log("Username is taken"),e.flash("error_msg","Username is taken"),r.render("register",{errors:[{msg:"Username is taken"}]});else if(null!=l)console.log("Email is already in use"),e.flash("error_msg","Email is already in use, try signing in, or registering with a different email address."),r.render("register",{errors:[{msg:"Email is already in use, try signing in, or registering with a different email address."}]});else{console.log("Success");var u=new User({name:s,email:i,username:o,password:n});User.createUser(u,function(e,r){if(e)throw e;console.log(r)}),e.flash("success_msg","you are registered and can now log in"),r.redirect("/users/login")}})})}),passport.use(new LocalStrategy(function(e,r,s){User.getUserByUsername(e,function(e,o){if(e)throw e;if(!o)return s(null,!1,{message:"Incorrect username"});User.comparePassword(r,o.password,function(e,r){if(e)throw e;return r?s(null,o):s(null,!1,{message:"Incorrect username or password"})})})})),passport.serializeUser(function(e,r){r(null,e.id)}),passport.deserializeUser(function(e,r){User.getUserByID(e,function(e,s){r(e,s)})}),router.post("/login",passport.authenticate("local",{successRedirect:"/",failureRedirect:"/users/login",failureFlash:!0}),function(e,r){e.flash("success_msg","You are logged in"),r.redirect("/")}),router.get("/logout",function(e,r){e.logout(),e.flash("success_msg","You are logged out"),r.redirect("/users/login")}),module.exports=router;